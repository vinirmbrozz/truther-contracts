name: Generate TypeScript SDK
on: [push]

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Protoc
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install TypeScript Protobuf Plugin
        run: |
          npm install ts-proto

      - name: Create Output Directory
        run: |
          mkdir -p gen/typescript

      - name: Create Package.json for SDK
        run: |
          cat > gen/typescript/package.json << 'EOF'
          {
            "name": "@truther/contracts-sdk",
            "version": "1.0.0",
            "description": "TypeScript SDK for Truther Contracts",
            "main": "transaction.js",
            "types": "transaction.ts",
            "keywords": ["truther", "contracts", "protobuf"],
            "author": "vinirmbrozz",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/vinirmbrozz/truther-contracts.git"
            }
          }
          EOF

      - name: Compile Protobuf to TypeScript
        run: |
          protoc --proto_path=proto \
            --plugin=protoc-gen-ts_proto=$(npm root)/ts-proto/protoc-gen-ts_proto \
            --ts_proto_out=gen/typescript \
            --ts_proto_opt=esModuleInterop=true \
            proto/transaction.proto

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update generated TypeScript SDK [skip ci]"
          file_pattern: 'gen/typescript/*'